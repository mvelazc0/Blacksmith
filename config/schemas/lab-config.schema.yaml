# JSON Schema for Blacksmith Lab Configuration
# This schema validates the YAML configuration files

$schema: "http://json-schema.org/draft-07/schema#"
title: "Blacksmith Lab Configuration"
description: "Schema for defining Azure lab environments"
type: object

required:
  - name
  - location
  - network
  - credentials
  - virtual_machines

properties:
  name:
    type: string
    description: "Unique name for the lab environment"
    pattern: "^[a-z0-9-]+$"
    minLength: 3
    maxLength: 50

  description:
    type: string
    description: "Description of the lab environment"
    maxLength: 500

  location:
    type: string
    description: "Azure region for deployment"
    enum:
      - eastus
      - eastus2
      - westus
      - westus2
      - centralus
      - northcentralus
      - southcentralus
      - westcentralus
      - canadacentral
      - canadaeast
      - brazilsouth
      - northeurope
      - westeurope
      - uksouth
      - ukwest
      - francecentral
      - germanywestcentral
      - switzerlandnorth
      - norwayeast
      - southeastasia
      - eastasia
      - australiaeast
      - australiasoutheast
      - japaneast
      - japanwest
      - koreacentral
      - southafricanorth
      - uaenorth
      - centralindia
      - southindia

  resource_group:
    type: string
    description: "Azure resource group name"
    pattern: "^[a-zA-Z0-9-_]+$"
    minLength: 1
    maxLength: 90

  network:
    type: object
    required:
      - vnet_name
      - address_space
    properties:
      vnet_name:
        type: string
        pattern: "^[a-zA-Z0-9-_]+$"
        minLength: 2
        maxLength: 64

      address_space:
        type: string
        pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
        description: "CIDR notation (e.g., 192.168.0.0/16)"

      subnets:
        type: array
        minItems: 1
        items:
          type: object
          required:
            - name
            - address_prefix
          properties:
            name:
              type: string
              pattern: "^[a-zA-Z0-9-_]+$"
            address_prefix:
              type: string
              pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"

      nsg:
        type: object
        properties:
          name:
            type: string
          rules:
            type: array
            items:
              type: object
              required:
                - name
                - priority
                - direction
                - access
                - protocol
                - destination_port
              properties:
                name:
                  type: string
                priority:
                  type: integer
                  minimum: 100
                  maximum: 4096
                direction:
                  enum: [Inbound, Outbound]
                access:
                  enum: [Allow, Deny]
                protocol:
                  enum: [Tcp, Udp, "*"]
                source_port:
                  type: string
                destination_port:
                  type: string
                source_address:
                  type: string

      remote_access:
        type: object
        properties:
          mode:
            enum: [AllowPublicIP, AzureBastionHost]
          allowed_ips:
            type: array
            items:
              type: string
              pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}(/[0-9]{1,2})?$"
          bastion:
            type: object
            properties:
              enabled:
                type: boolean
              subnet_prefix:
                type: string
                pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"

  credentials:
    type: object
    required:
      - admin_username
      - admin_password
    properties:
      admin_username:
        type: string
        minLength: 1
        maxLength: 20
        pattern: "^[a-zA-Z][a-zA-Z0-9-_]*$"
      admin_password:
        type: string
        minLength: 12
        maxLength: 123
        description: "Must contain uppercase, lowercase, digit, and special character"

  virtual_machines:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - type
      oneOf:
        - required: [name]
        - required: [suffix]
      properties:
        name:
          type: string
          pattern: "^[a-zA-Z0-9-]+$"
          minLength: 1
          maxLength: 15
          description: "VM name (used as prefix when count > 1 or as full name when count = 1). Either 'name' or 'suffix' must be provided."

        suffix:
          type: string
          pattern: "^[a-zA-Z0-9-]+$"
          minLength: 1
          maxLength: 10
          description: "VM naming prefix/suffix (e.g., 'srv', 'ws', 'dev'). Either 'name' or 'suffix' must be provided."

        naming_pattern:
          type: string
          enum:
            - "suffix-number"
            - "number-suffix"
            - "suffix-only"
          default: "suffix-number"
          description: "Naming pattern: 'suffix-number' (srv01), 'number-suffix' (01srv), 'suffix-only' (srv1)"

        type:
          enum:
            - windows_server
            - windows_desktop
            - linux

        role:
          enum:
            - domain_controller
            - adfs
            - wec
            - exchange
            - generic

        count:
          type: integer
          minimum: 1
          maximum: 100
          default: 1
          description: "Number of VMs to create with this configuration"

        size:
          type: string
          enum:
            - Standard_B2s
            - Standard_B2ms
            - Standard_B4ms
            - Standard_B8ms
            - Standard_A2_v2
            - Standard_A4_v2
            - Standard_A8_v2
            - Standard_D2_v3
            - Standard_D4_v3
            - Standard_D8_v3

        os:
          type: object
          properties:
            sku:
              type: string
            version:
              type: string
              default: "latest"

        network:
          type: object
          properties:
            subnet:
              type: string
              description: "Subnet name (optional - can be auto-assigned based on domain)"
            private_ip:
              type: string
              pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}$"
            ip_start:
              type: string
              pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}$"

        depends_on:
          type: array
          items:
            type: string

        identity:
          type: object
          properties:
            type:
              enum: [SystemAssigned, UserAssigned, None]
            user_assigned_identities:
              type: array
              items:
                type: string

  active_directory:
    type: object
    properties:
      enabled:
        type: boolean
        default: false

      domain_fqdn:
        type: string
        pattern: "^[a-zA-Z0-9][a-zA-Z0-9-]*\\.[a-zA-Z]{2,}$"

      domain_netbios:
        type: string
        pattern: "^[a-zA-Z0-9]+$"
        maxLength: 15

      groups:
        type: array
        items:
          type: object
          required:
            - name
          properties:
            name:
              type: string
              pattern: "^[a-zA-Z0-9 ]+$"
              maxLength: 64
              description: "AD group name"
            description:
              type: string
              maxLength: 256
            scope:
              type: string
              enum: [DomainLocal, Global, Universal]
              default: Global
            members:
              type: array
              items:
                type: string
              description: "SAM account names of users to add to this group"
            local_admin_on:
              type: array
              items:
                type: object
                properties:
                  type:
                    type: string
                    enum: [windows_server, windows_desktop, linux]
                    description: "Grant local admin on all VMs of this type"
                  role:
                    type: string
                    enum: [domain_controller, adfs, wec, exchange, generic]
                    description: "Grant local admin on all VMs with this role"
                  suffix:
                    type: string
                    description: "Grant local admin on all VMs with this suffix"
                  name:
                    type: string
                    description: "Grant local admin on specific VM by name"
              description: "Define which VMs this group should have local admin rights on"

      users:
        type: array
        items:
          type: object
          required:
            - first_name
            - last_name
            - sam_account
            - password
          properties:
            first_name:
              type: string
            last_name:
              type: string
            sam_account:
              type: string
              pattern: "^[a-zA-Z0-9]+$"
              maxLength: 20
            password:
              type: string
              minLength: 8
            department:
              type: string
            job_title:
              type: string
            groups:
              type: array
              items:
                type: string

  services:
    type: object
    properties:
      adfs:
        type: object
        properties:
          enabled:
            type: boolean
            default: false
          server:
            type: string
          service_account:
            type: object
            properties:
              username:
                type: string
              password:
                type: string
          certificate:
            type: object
            properties:
              type:
                enum: [SelfSigned, TrustedSigned]
              name:
                type: string
              password:
                type: string
              blob_url:
                type: string
                format: uri

      wec:
        type: object
        properties:
          enabled:
            type: boolean
            default: false
          server:
            type: string
          subscriptions_url:
            type: string
            format: uri

      exchange:
        type: object
        properties:
          enabled:
            type: boolean
            default: false
          server:
            type: string
          version:
            enum: ["2016", "2019"]

  features:
    type: object
    properties:
      sysmon:
        type: object
        properties:
          enabled:
            type: boolean
            default: false
          targets:
            type: array
            items:
              type: string

      aad_connect:
        type: object
        properties:
          enabled:
            type: boolean
            default: false
          server:
            type: string

      monitoring:
        type: object
        properties:
          enabled:
            type: boolean
            default: false
          workspace_id:
            type: string
          workspace_key:
            type: string

      logging:
        type: object
        properties:
          enabled:
            type: boolean
            default: false
          workspace:
            type: object
            properties:
              name:
                type: string
                pattern: "^[a-zA-Z0-9-]+$"
                minLength: 4
                maxLength: 63
              retention_days:
                type: integer
                minimum: 7
                maximum: 730
                default: 30
              pricing_tier:
                type: string
                enum:
                  - PerGB2018
                  - Free
                  - Standalone
                  - PerNode
                  - Standard
                  - Premium
                default: PerGB2018
              enable_sentinel:
                type: boolean
                default: false
                description: "Enable Microsoft Sentinel on the workspace"
          data_collection_rules:
            type: array
            items:
              type: object
              required:
                - name
                - data_sources
              properties:
                name:
                  type: string
                  pattern: "^[a-zA-Z0-9-]+$"
                data_sources:
                  type: object
                  properties:
                    windows_event_logs:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          streams:
                            type: array
                            items:
                              type: string
                          x_path_queries:
                            type: array
                            items:
                              type: string
                    performance_counters:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          streams:
                            type: array
                            items:
                              type: string
                          sampling_frequency_in_seconds:
                            type: integer
                            default: 60
                          counter_specifiers:
                            type: array
                            items:
                              type: string
                    sysmon:
                      type: boolean
                      default: false
                targets:
                  type: array
                  items:
                    type: string
                  description: "VM names to apply DCR to (empty means all VMs)"

  # Multi-Domain Configuration (new)
  domains:
    type: array
    description: "Multi-domain/multi-forest configuration (alternative to active_directory)"
    minItems: 1
    items:
      type: object
      required:
        - name
        - type
        - dc_vm
        - dc_ip
      properties:
        name:
          type: string
          pattern: "^[a-zA-Z0-9][a-zA-Z0-9.-]*\\.[a-zA-Z]{2,}$"
          description: "Domain FQDN (e.g., corp.local or dev.corp.local)"
        
        netbios:
          type: string
          pattern: "^[a-zA-Z0-9]+$"
          maxLength: 15
          description: "NetBIOS name (optional, auto-derived from FQDN if not provided)"
        
        type:
          type: string
          enum: [forest_root, child_domain]
          description: "Domain type: forest_root for new forest, child_domain for child domain"
        
        parent:
          type: string
          pattern: "^[a-zA-Z0-9][a-zA-Z0-9.-]*\\.[a-zA-Z]{2,}$"
          description: "Parent domain FQDN (required for child_domain type)"
        
        dc_vm:
          type: string
          description: "VM name or suffix for the domain controller"
        
        dc_ip:
          type: string
          pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}$"
          description: "Static IP address for the domain controller"
        
        functional_level:
          type: string
          enum: [WinThreshold, Win2016, Win2019]
          default: "WinThreshold"
          description: "Domain functional level"
        
        # Domain-specific subnets
        subnets:
          type: array
          description: "Subnets specific to this domain"
          items:
            type: object
            required:
              - name
              - address_prefix
            properties:
              name:
                type: string
                pattern: "^[a-zA-Z0-9-_]+$"
              address_prefix:
                type: string
                pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
              description:
                type: string
              nsg:
                type: object
                properties:
                  name:
                    type: string
                  rules:
                    type: array
                    items:
                      type: object
                      required:
                        - name
                        - priority
                        - direction
                        - access
                        - protocol
                        - destination_port
                      properties:
                        name:
                          type: string
                        priority:
                          type: integer
                          minimum: 100
                          maximum: 4096
                        direction:
                          enum: [Inbound, Outbound]
                        access:
                          enum: [Allow, Deny]
                        protocol:
                          enum: [Tcp, Udp, "*"]
                        source_port:
                          type: string
                        destination_port:
                          type: string
                        source_address:
                          type: string
        
        # Subnet assignment rules
        subnet_assignment:
          type: object
          description: "Automatic subnet assignment based on VM type"
          properties:
            domain_controller:
              type: string
            windows_server:
              type: string
            windows_desktop:
              type: string
            linux:
              type: string
        
        subnet_assignment_by_role:
          type: object
          description: "Subnet assignment based on VM role (overrides type-based)"
          additionalProperties:
            type: string
        
        # Domain groups
        groups:
          type: array
          items:
            type: object
            required:
              - name
            properties:
              name:
                type: string
                pattern: "^[a-zA-Z0-9 ]+$"
                maxLength: 64
              description:
                type: string
                maxLength: 256
              scope:
                type: string
                enum: [DomainLocal, Global, Universal]
                default: Global
              members:
                type: array
                items:
                  type: string
              local_admin_on:
                type: array
                items:
                  type: object
                  properties:
                    domain:
                      type: string
                      description: "Target domain FQDN (defaults to group's domain)"
                    type:
                      type: string
                      enum: [windows_server, windows_desktop, linux]
                    role:
                      type: string
                      enum: [domain_controller, adfs, wec, exchange, generic]
                    suffix:
                      type: string
                    name:
                      type: string
        
        # Domain users
        users:
          type: array
          items:
            type: object
            required:
              - first_name
              - last_name
              - sam_account
              - password
            properties:
              first_name:
                type: string
              last_name:
                type: string
              sam_account:
                type: string
                pattern: "^[a-zA-Z0-9]+$"
                maxLength: 20
              password:
                type: string
                minLength: 8
              department:
                type: string
              job_title:
                type: string
              groups:
                type: array
                items:
                  type: string
        
        # Endpoint assignments
        endpoints:
          type: array
          description: "VM names/suffixes that belong to this domain"
          items:
            type: string
  
  # Trust relationships
  trusts:
    type: array
    description: "Trust relationships between domains/forests"
    items:
      type: object
      required:
        - source
        - target
        - type
        - direction
        - trust_password
      properties:
        source:
          type: string
          pattern: "^[a-zA-Z0-9][a-zA-Z0-9.-]*\\.[a-zA-Z]{2,}$"
          description: "Source domain FQDN"
        
        target:
          type: string
          pattern: "^[a-zA-Z0-9][a-zA-Z0-9.-]*\\.[a-zA-Z]{2,}$"
          description: "Target domain FQDN"
        
        type:
          type: string
          enum: [forest, external, shortcut]
          description: "Trust type: forest (between forest roots), external (between domains), shortcut (within forest)"
        
        direction:
          type: string
          enum: [bidirectional, oneway-outbound, oneway-inbound]
          description: "Trust direction"
        
        trust_password:
          type: string
          minLength: 12
          description: "Password for the trust relationship"
        
        selective_auth:
          type: boolean
          default: false
          description: "Enable selective authentication"

  tags:
    type: object
    additionalProperties:
      type: string
    description: "Azure resource tags"

additionalProperties: false