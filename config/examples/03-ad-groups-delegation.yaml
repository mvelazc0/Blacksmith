# Blacksmith Lab Configuration - Level 3: AD Groups & Access Control
# Scenario: Granular access control for attack path scenarios
# Infrastructure: 1 DC + 4 servers + 4 workstations + 1 attack VM
# Purpose: Demonstrate AD groups with local admin delegation (by type, suffix, specific VM)

name: "ad-groups-delegation-lab"
description: "Lab demonstrating AD groups with granular local administrator delegation for attack path scenarios"
location: "westus2"
resource_group: "rg-blacksmith-admin-groups1"
append_random_suffix: true

# Network Configuration
network:
  vnet_name: "vnet-lab"
  address_space: "192.168.0.0/16"
  
  subnets:
    - name: "snet-servers"
      address_prefix: "192.168.1.0/24"
    - name: "snet-workstations"
      address_prefix: "192.168.2.0/24"
    - name: "snet-attack"
      address_prefix: "192.168.4.0/24"
  
  remote_access:
    mode: "AzureBastionHost"
    bastion:
      enabled: true
      subnet_prefix: "192.168.3.0/26"

# Credentials
credentials:
  admin_username: "labadmin"
  admin_password: "YourSecurePassword123!"
  store_in_keyvault: true

# Virtual Machines
virtual_machines:
  # Domain Controller
  - name: "DC01"
    type: "windows_server"
    role: "domain_controller"
    size: "Standard_B2ms"
    os:
      sku: "2019-Datacenter"
    network:
      subnet: "snet-servers"
      private_ip: "192.168.1.4"
  
  # Web Servers
  - suffix: "web"
    count: 2
    naming_pattern: "suffix-number"
    type: "windows_server"
    size: "Standard_B2ms"
    os:
      sku: "2019-Datacenter"
    network:
      subnet: "snet-servers"
      ip_start: "192.168.1.10"
  
  # Database Servers
  - suffix: "db"
    count: 2
    naming_pattern: "suffix-number"
    type: "windows_server"
    size: "Standard_B4ms"
    os:
      sku: "2019-Datacenter"
    network:
      subnet: "snet-servers"
      ip_start: "192.168.1.20"
  
  # Development Workstations
  - suffix: "dev"
    count: 2
    naming_pattern: "suffix-number"
    type: "windows_desktop"
    size: "Standard_B2ms"
    os:
      sku: "win10-22h2-pro"
    network:
      subnet: "snet-workstations"
      ip_start: "192.168.2.10"
  
  # QA Workstations
  - suffix: "qa"
    count: 2
    naming_pattern: "suffix-number"
    type: "windows_desktop"
    size: "Standard_B2ms"
    os:
      sku: "win10-22h2-pro"
    network:
      subnet: "snet-workstations"
      ip_start: "192.168.2.20"

# Attack VM Configuration
attack_vm:
  enabled: false
  name: "UBUNTU01"
  type: "ubuntu"  # Using Ubuntu due to Azure Marketplace restrictions on Kali
  size: "Standard_B2ms"
  os:
    # Ubuntu Server 22.04 LTS (no Marketplace restrictions)
    publisher: "Canonical"
    offer: "0001-com-ubuntu-server-jammy"
    sku: "22_04-lts-gen2"
    version: "latest"
  network:
    subnet: "snet-attack"
    private_ip: "192.168.4.10"
  # Optional: Pre-install attack tools (will be installed via custom script)
  tools:
    - "nmap"  # Minimal test - just install nmap
  # Optional: Custom scripts to run on first boot
  # custom_scripts:
  #   - "https://raw.githubusercontent.com/mvelazc0/Blacksmith/refs/heads/master/resources/scripts/bash/Install-C2s.sh"

# Active Directory Configuration
active_directory:
  enabled: true
  domain_fqdn: "corp.local"
  domain_netbios: "CORP"
  
  # Define AD Groups with granular local admin targeting
  groups:
    # Tier 1: Broad access groups
    - name: "Server Admins"
      description: "Administrators for all servers"
      scope: "Global"
      members: ["alice"]
      local_admin_on:
        - type: "windows_server"  # Local admin on ALL servers
    
    - name: "Workstation Admins"
      description: "Administrators for all workstations"
      scope: "Global"
      members: ["charlie"]
      local_admin_on:
        - type: "windows_desktop"  # Local admin on ALL workstations
    
    # Tier 2: Role-specific groups
    - name: "DB Admins"
      description: "Database administrators"
      scope: "Global"
      members: ["dave", "eve"]
      local_admin_on:
        - suffix: "db"  # Local admin only on db01, db02
    
    - name: "Web Admins"
      description: "Web server administrators"
      scope: "Global"
      members: ["frank"]
      local_admin_on:
        - suffix: "web"  # Local admin only on web01, web02
    
    # Tier 3: Specific VM access (for targeted attack paths)
    - name: "DB01 Operators"
      description: "Operators for primary database only"
      scope: "Global"
      members: ["bob"]
      local_admin_on:
        - name: "db01"  # Local admin ONLY on db01 (not db02)
  
  # Define domain users
  users:
    # Tier 1 - Broad access
    - first_name: "Alice"
      last_name: "Admin"
      sam_account: "alice"
      password: "ComplexP@ssw0rd1!"
      department: "IT"
      job_title: "Server Administrator"
      groups: ["Server Admins"]
    
    - first_name: "Charlie"
      last_name: "Desktop"
      sam_account: "charlie"
      password: "ComplexP@ssw0rd2!"
      department: "IT"
      job_title: "Desktop Administrator"
      groups: ["Workstation Admins"]
    
    # Tier 2 - Role-specific
    - first_name: "Dave"
      last_name: "Database"
      sam_account: "dave"
      password: "ComplexP@ssw0rd3!"
      department: "Database"
      job_title: "DBA"
      groups: ["DB Admins"]
    
    - first_name: "Eve"
      last_name: "Database"
      sam_account: "eve"
      password: "ComplexP@ssw0rd4!"
      department: "Database"
      job_title: "Junior DBA"
      groups: ["DB Admins"]
    
    - first_name: "Frank"
      last_name: "Web"
      sam_account: "frank"
      password: "ComplexP@ssw0rd5!"
      department: "Web"
      job_title: "Web Administrator"
      groups: ["Web Admins"]
    
    # Tier 3 - Specific access
    - first_name: "Bob"
      last_name: "Operator"
      sam_account: "bob"
      password: "ComplexP@ssw0rd6!"
      department: "Operations"
      job_title: "Database Operator"
      groups: ["DB01 Operators"]

# Features
features:
  logging:
    enabled: true
    workspace:
      name: "admin-groups-logs"
      retention_days: 30
      pricing_tier: "PerGB2018"
      enable_sentinel: true
    
    data_collection_rules:
      - name: "dcr-windows-security"
        data_sources:
          windows_event_logs:
            - name: "SecurityEvents"
              streams:
                - "Microsoft-SecurityEvent"
              x_path_queries:
                # AD Object Changes (5136, 5139)
                - "Security!*[System[(EventID=5136 or EventID=5139)]]"
                # AD Object Undelete (5137)
                - "Security!*[System[(EventID=5137)]]"
                # AD Object Delete (5141)
                - "Security!*[System[(EventID=5141)]]"
                # Directory Service Access (4662, 4661)
                - "Security!*[System[(EventID=4662 or EventID=4661)]]"
                # Kerberos Authentication (4768, 4769)
                - "Security!*[System[(EventID=4768 or EventID=4769)]]"
                # Process Creation (4688)
                - "Security!*[System[(EventID=4688)]]"
                # Object Deleted (4660)
                - "Security!*[System[(EventID=4660)]]"
                # File/SAM Access (4656, 4663, 4661)
                - "Security!(*[System[EventID=4656]] and ((*[EventData[Data[@Name='ObjectType']='File']]))) or (*[System[EventID=4663]] and ((*[EventData[Data[@Name='ObjectType']='File']]))) or (*[System[EventID=4661]] and ((*[EventData[Data[@Name='ObjectType']='SAM']])))"
                # Logon Events (4624, 4625, 4648, 4778, 4964)
                - "Security!*[System[(EventID=4624 or EventID=4625 or EventID=4648 or EventID=4778 or EventID=4964)]]"
                # Network Share Access (5140, 5145)
                - "Security!*[System[(EventID=5140 or EventID=5145)]]"
                # Filtering Platform Connection (5154, 5159, 5155, 5158, 5156, 5157, 5031)
                - "Security!*[System[(EventID=5154 or EventID=5159 or EventID=5155 or EventID=5158 or EventID=5156 or EventID=5157 or EventID=5031)]]"
                # Process Access (4656, 4663 for Process objects)
                - "Security!(*[System[EventID=4656]] and ((*[EventData[Data[@Name='ObjectType']='Process']]))) or (*[System[EventID=4663]] and ((*[EventData[Data[@Name='ObjectType']='Process']])))"
                # Process Termination (4689)
                - "Security!*[System[(EventID=4689)]]"
                # Scheduled Task Operations (4698, 4699, 4700, 4701, 4702)
                - "Security!*[System[(EventID=4698 or EventID=4699 or EventID=4700 or EventID=4701 or EventID=4702)]]"
                # Service Installation (4697)
                - "Security!*[System[(EventID=4697)]]"
                # User Account Changes (4720, 4722, 4725, 4726, 4717, 4740, 4738, 4781, 4767, 4718)
                - "Security!*[System[(EventID=4720 or EventID=4722 or EventID=4725 or EventID=4726 or EventID=4717 or EventID=4740 or EventID=4738 or EventID=4781 or EventID=4767 or EventID=4718)]]"
                # Object Access Auditing (4670, 4657)
                - "Security!*[System[(EventID=4670 or EventID=4657)]]"
                # Registry Access (4656, 4663 for Key objects)
                - "Security!(*[System[EventID=4656]] and ((*[EventData[Data[@Name='ObjectType']='Key']]))) or (*[System[EventID=4663]] and ((*[EventData[Data[@Name='ObjectType']='Key']])))"
                # Key Migration (5058, 5061)
                - "Security!*[System[(EventID=5058 or EventID=5061)]]"

            # System Event Log - Service Creation, System Changes, Crashes
            - name: "SystemEvents"
              streams:
                - "Microsoft-Event"
              x_path_queries:
                # ============================================
                # PERSISTENCE & LATERAL MOVEMENT
                # ============================================
                
                # Service Installed (7045) - Malicious service creation, PsExec
                - "System!*[System[(EventID=7045)]]"
                
                # Service Started/Stopped (7036) - Track service execution and manipulation
                - "System!*[System[(EventID=7036)]]"
                
                # Service Control Manager (7040) - Service config changes
                - "System!*[System[(EventID=7040)]]"
                
                # ============================================
                # SYSTEM INTEGRITY & CRASHES
                # ============================================
                
                # System Startup (6005, 6009) - Reboot detection
                - "System!*[System[(EventID=6005 or EventID=6009)]]"
                
                # System Shutdown (6006) - Unexpected shutdowns
                - "System!*[System[(EventID=6006)]]"
                
                # Application Crash (1000, 1001) - Exploitation attempts
                - "System!*[System[Provider[@Name='Application Error'] and (EventID=1000 or EventID=1001)]]"
                
                # Windows Error Reporting (1001) - Crash dumps
                - "System!*[System[Provider[@Name='Windows Error Reporting'] and (EventID=1001)]]"
                
                # ============================================
                # DRIVER & KERNEL CHANGES
                # ============================================
                
                # Driver Loaded (7000, 7001, 7026) - Rootkit detection
                - "System!*[System[(EventID=7000 or EventID=7001 or EventID=7026)]]"
                
                # Kernel Driver Signing (219) - Unsigned driver loaded
                - "System!*[System[Provider[@Name='Microsoft-Windows-Kernel-PnP'] and (EventID=219)]]"
                
                # ============================================
                # TIME MANIPULATION
                # ============================================
                
                # System Time Changed (1) - Kerberos ticket manipulation
                - "System!*[System[Provider[@Name='Microsoft-Windows-Kernel-General'] and (EventID=1)]]"
                
                # ============================================
                # REMOTE CONNECTIONS
                # ============================================
                
                # Remote Desktop Services (1149) - RDP connection established
                - "System!*[System[Provider[@Name='Microsoft-Windows-TerminalServices-RemoteConnectionManager'] and (EventID=1149)]]"
                
                # RDP Session Reconnection (4624) - Session hijacking
                - "System!*[System[Provider[@Name='Microsoft-Windows-TerminalServices-LocalSessionManager'] and (EventID=21, 22, 24, 25)]]"
          
          performance_counters:
            - name: "BasicPerfCounters"
              streams:
                - "Microsoft-Perf"
              sampling_frequency_in_seconds: 60
              counter_specifiers:
                - "\\Processor(_Total)\\% Processor Time"
                - "\\Memory\\Available MBytes"
                - "\\LogicalDisk(_Total)\\% Free Space"
        
        targets:
          types:
            - "windows_server"
            - "windows_desktop"

# Security Software Configuration
security_software:
  mde:
    enabled: false
    onboarding_package_url: "https://installers.blob.core.windows.net/installers/WindowsDefender.zip"
    targets:
      types:
        - "windows_server"
        - "windows_desktop"
    install_after_domain_join: true