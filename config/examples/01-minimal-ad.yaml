# Blacksmith Lab Configuration - Level 1: Minimal AD Lab
# Scenario: Quick start with all core features
# Infrastructure: 1 DC + 1 workstation + 1 attack VM
# Purpose: Get a working lab with all security features in minutes

name: "minimal-ad-lab"
description: "Minimal Active Directory lab with one DC and one workstation"
location: "westus2"
resource_group: "rg-blacksmith-minimal032"
append_random_suffix: true

# Network Configuration
network:
  vnet_name: "vnet-minimal"
  address_space: "192.168.0.0/16"
  
  subnets:
    - name: "snet-default"
      address_prefix: "192.168.1.0/24"
    - name: "snet-attack"
      address_prefix: "192.168.3.0/24"
    
  remote_access:
    mode: "AzureBastionHost"
    bastion:
      enabled: true
      subnet_prefix: "192.168.2.0/26"

# Credentials
credentials:
  admin_username: "labadmin"
  admin_password: "YourSecurePassword123!"
  store_in_keyvault: true  # Store password in Key Vault for easy Bastion access (no copy/paste!)

# Virtual Machines
virtual_machines:
  - name: "DC01"
    type: "windows_server"
    role: "domain_controller"
    size: "Standard_B2ms"
    os:
      sku: "2019-Datacenter"
      version: "latest"
    network:
      subnet: "snet-default"
      private_ip: "192.168.1.4"
  
  - name: "WS5"
    type: "windows_desktop"
    size: "Standard_B2ms"
    os:
      sku: "win10-22h2-pro"
      version: "latest"
    network:
      subnet: "snet-default"
      private_ip: "192.168.1.5"
    depends_on:
      - "DC01"

# Attack VM Configuration
attack_vm:
  enabled: true
  name: "UBUNTU01"
  type: "ubuntu"
  size: "Standard_B2ms"
  os:
    publisher: "Canonical"
    offer: "0001-com-ubuntu-server-jammy"
    sku: "22_04-lts-gen2"
    version: "latest"
  network:
    subnet: "snet-attack"
    private_ip: "192.168.3.10"
  tools:
    - "nmap"

# Active Directory Configuration
active_directory:
  enabled: true
  domain_fqdn: "lab.local"
  domain_netbios: "LAB"
  
  users:
    - first_name: "Test"
      last_name: "User"
      sam_account: "testuser"
      password: "ComplexP@ssw0rd123!"
      department: "IT"
      job_title: "Administrator"
      groups: ["Domain Admins"]

# Features
features:

  # Logging Configuration
  logging:
    enabled: true
    workspace:
      name: "minimal-ad-logs"
      retention_days: 30
      pricing_tier: "PerGB2018"
      enable_sentinel: true
    
    data_collection_rules:
      - name: "dcr-windows-security"
        data_sources:
          windows_event_logs:
            - name: "eventLogsDataSource"
              streams:
                - "Microsoft-Event"
              x_path_queries:
                - "Security!*[System[(band(Keywords,13510798882111488))]]"
                - "Application!*[System[(Level=1 or Level=2 or Level=3)]]"
                - "System!*[System[(Level=1 or Level=2 or Level=3)]]"
          performance_counters:
            - name: "BasicPerfCounters"
              streams:
                - "Microsoft-Perf"
              sampling_frequency_in_seconds: 60
              counter_specifiers:
                - "\\Processor(_Total)\\% Processor Time"
                - "\\Memory\\Available MBytes"
                - "\\LogicalDisk(_Total)\\% Free Space"
        targets:
          types:
            - "windows_server"
            - "windows_desktop"

# Security Software Configuration
security_software:
  # Microsoft Defender for Endpoint
  mde:
    enabled: false
    onboarding_package_url: "https://installers.blob.core.windows.net/installers/WindowsDefender.zip"
    targets:
      types:
        - "windows_server"
        - "windows_desktop"
    install_after_domain_join: true