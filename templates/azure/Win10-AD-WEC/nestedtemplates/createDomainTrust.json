{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "vmName": {
      "type": "string",
      "metadata": {
        "description": "VM name for the source domain controller"
      }
    },
    "createTrustScript": {
      "type": "string",
      "metadata": {
        "description": "URL to Create-Domain-Trust.zip DSC script"
      }
    },
    "sourceDomainFQDN": {
      "type": "string",
      "metadata": {
        "description": "Source domain FQDN"
      }
    },
    "targetDomainFQDN": {
      "type": "string",
      "metadata": {
        "description": "Target domain FQDN"
      }
    },
    "targetDCIPAddress": {
      "type": "string",
      "metadata": {
        "description": "Target domain controller IP address"
      }
    },
    "trustType": {
      "type": "string",
      "allowedValues": ["Forest", "External", "Shortcut"],
      "metadata": {
        "description": "Type of trust relationship"
      }
    },
    "trustDirection": {
      "type": "string",
      "allowedValues": ["Bidirectional", "Inbound", "Outbound"],
      "metadata": {
        "description": "Direction of trust"
      }
    },
    "trustPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Trust password"
      }
    },
    "selectiveAuth": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable selective authentication"
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "Admin username"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin password"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location for resources"
      }
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2021-11-01",
      "name": "[concat(parameters('vmName'),'/CreateDomainTrust')]",
      "location": "[parameters('location')]",
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.77",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "wmfVersion": "latest",
          "configuration": {
            "url": "[parameters('createTrustScript')]",
            "script": "Create-Domain-Trust.ps1",
            "function": "Create-Domain-Trust"
          },
          "configurationArguments": {
            "SourceDomainFQDN": "[parameters('sourceDomainFQDN')]",
            "TargetDomainFQDN": "[parameters('targetDomainFQDN')]",
            "TargetDCIPAddress": "[parameters('targetDCIPAddress')]",
            "TrustType": "[parameters('trustType')]",
            "TrustDirection": "[parameters('trustDirection')]",
            "SelectiveAuth": "[parameters('selectiveAuth')]"
          }
        },
        "protectedSettings": {
          "configurationArguments": {
            "AdminCreds": {
              "UserName": "[parameters('adminUsername')]",
              "Password": "[parameters('adminPassword')]"
            },
            "TrustPassword": {
              "UserName": "trust",
              "Password": "[parameters('trustPassword')]"
            }
          }
        }
      }
    }
  ],
  "outputs": {}
}